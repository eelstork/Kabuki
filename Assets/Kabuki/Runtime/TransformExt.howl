âŠ Ex = System.Exception;
âŠ UnityEngine; âŠÌ¥ UnityEngine.Time; âŠÌ¥ UnityEngine.Mathf;
âŠ Active.Core; âŠÌ¥ Active.Status;

âŠ“ Activ.Kabuki{
â€’Ì¥ â—‹ TransformExt{

    â€’Ì¥ ã‚· Dir(â¦¿ ã‚¨ x, ã‚¨ y, ã…‡ planar = âœ—)
        â†’ planar ? (yË™ - xË™).X_Z()Â¹ : (yË™ - xË™)Â¹;

    â€’Ì¥ ã‚· Dir(â¦¿ ã‚¨ x, ãƒ¡ y, ã…‡ planar = âœ—)
        â†’ planar ? (y - xË™).X_Z()Â¹ : (y - xË™)Â¹;

    â€’Ì¥ ã…… Dist(â¦¿ ã‚¨ x, ã‚¨ y) â†’ ãƒ¡.Distance(xË™, yË™);

    â€’Ì¥ ã…… Radius(â¦¿ ã‚¨ x){
        âˆ™ bounds = x.GetComponentInChildren<Renderer>().bounds;
        âˆ™ s = bounds.size;
        â® (s.x + s.y + s.z) / 6 á§ 0.7f;
    }

    â€’Ì¥ ã‚¨ Req(â¦¿ ã‚¨ x, â‹¯ ã„¹[] hints){
        âˆ™ ã„¸ = x.Find(hints);
        â® ã„¸ â‰  âˆ… ? ã„¸ : (â•¯Â°â–¡Â°)â•¯ âŒ¢ Ex("Not found: " + hints);

    }

    â€’Ì¥ ã‚¨ Find(â¦¿ ã‚¨ x, â‹¯ ã„¹[] hints){
        âˆ€ (ã‚¨ child âˆˆ x){
            âˆ™ name = childË®.ToLower();  ã…‡ match = âœ“;
            âˆ€ (âˆ™ h âˆˆ hints) â¤´ (!name.âˆ‹(h)){ match = false; Â¦ }
            â¤´ (match) â® child;
            âˆ™ ã„¸ = child.Find(hints);
            â¤´ (ã„¸ â‰  âˆ…) â® ã„¸;
        }
        â‚
    }

    â€’Ì¥ ã…‡ Has(â¦¿ ã‚¨ x, ã‚¨ y) â†’ y.IsAncestor(x);

    // is y an ancestor of x?
    â€’Ì¥ ã…‡ IsAncestor(â¦¿ ã‚¨ x, ã‚¨ y){
        âŸ² (x â‰  null){
            â¤´ (x â˜° y) ã†‘
            x = x.parent;
        } â¤¬
    }

    â€’Ì¥ ã…… Look(â¦¿ ã‚¨ x, ã‚¨ y, ã…‡ planar = âœ“)
    â†’ ã‚·.Angle(x.forward, x.Dir(y, planar: planar));

    â€’Ì¥ â‘‚ MoveTo(â¦¿ ã‚¨ x, ãƒ¡ y, ã…… speed){
        â¤´ (xË™ â˜° y) â—‡Ì 
        ã…… d = PlanarDist(x, y);
        ã…… Î´ = Mathf.Min(ğ›¿ğš á§ ğ‡, d);
        ã‚· u = x.PlanarDir(y);
        â® Run(xË™ += u á§ Î´);
    }

    â€’Ì¥ â‘‚ MoveTowards(â¦¿ ã‚¨ x, ã‚· y, ã…… dist, ã…… speed)
        â†’ x.PlanarDist(y) < dist
        âˆ¨ Run( xË™ += x.PlanarDir(y) á§ ğ›¿ğš á§ ğ‡ );

    â€’Ì¥ â‘‚ MoveTowards(â¦¿ ã‚¨ x, ã‚¨ y, ã…… dist, ã…… speed)
        â†’ x.PlanarDist(y) < dist
        âˆ¨ Run( xË™ += x.PlanarDir(y) á§ ğ›¿ğš á§ ğ‡ );

    â€’Ì¥ ã…… PlanarDist(â¦¿ ã‚¨ x, ã‚· y) â†’ (y - xË™).X_Z()âš;

    â€’Ì¥ ã…… PlanarDist(â¦¿ ã‚¨ x, ã‚¨ y) â†’ PlanarDist(x, yË™);

    â€’Ì¥ ã‚· PlanarDir(â¦¿ ã‚¨ x, ã‚· y) â†’ (y - xË™).X_Z()Â¹;

    â€’Ì¥ ã‚· PlanarDir(â¦¿ ã‚¨ x, ã‚¨ y) â†’ PlanarDir(x, yË™);

    â€’Ì¥ â‘‚ RotateTowards(â¦¿ ã‚¨ Î¸, ã‚¨ â§•, ã…… speed, ã…… Î¼ = 0.1f){
        ã‚· u = Î¸.â««, v = Î¸.Dir(â§•, planar: âœ“);
        â® ( ã‚·.Angle(u, v) < Î¼ )  ? â—‡
           : Run( Î¸.â«« = ãƒ¡.RotateTowards(u, v, ğ‡ á§ ğ›¿ğš á§ âˆ Ê³, 1f) );
    }

    â€’Ì¥ â‘‚ RotateTowards(â¦¿ ã‚¨ Î¸, ãƒ¡ pos, ã…… speed, ã…… Î¼ = 0.1f){
        ã‚· u = Î¸.forward, dir = Î¸.Dir(pos, planar: âœ“);
        ã…… Î± = ã‚·.Angle(u, dir);
        â¤´ (Î± < Î¼) â—‡Ì 
        Î¸.forward = ã‚·.RotateTowards(u, dir, ğ‡ á§ ğ›¿ğš á§ âˆ Ê³, 1f);
        â˜¡Ì±
    }

    âˆ˜ â–· Log(ã„¹ arg){
        Debug.Log(arg + $" @{Time.frameCount}");
        âŒ½
    }

    // --------------------------------------------------------------

    âˆ˜ â‘‚ Do(âŠ¡ x) { âŒ½ }
    âˆ˜ â‘‚ Run(âŠ¡ x) { â˜¡Ì± }

}}
