⊐ Ex = System.Exception;
⊐ T = UnityEngine.Transform; ⊐ UnityEngine;
⊐ Active.Core; ⊐̥ Active.Core.status; ⊐ Active.Util;

⊓ Activ.Kabuki{
‒ ○ Actor : XTask{

    ‒ ㅅ speed = 1, rotationSpeed = 180;
    ‒ エ leftHold, rightHold; // for holding an object in hand
    ‒ エ[] pushingBones;      // contact points for pushing
    ‒ Actor other;           // for give/take interaction
    ‒ エ gift;

    // --------------------------------------------------------------

    ‒ ⑂ ⦿[ㄹ gesture, エ ⧕] → LookAt(⧕) ∧ Play(gesture);

    ‒ ⑂ ⦿[ㄹ anim] → Play(anim);

    ‒ ⑂ Face(エ ⧕, ㄹ anim = "Walk")
        → ⸨ み.RotateTowards(⧕, rotationSpeed) ≫ ⦿[anim] ⸩;

    ‒ ⑂ Face(シ dir, ㄹ anim = "Walk")
        → Playing(anim, み.RotateTowards(dir, rotationSpeed));

    ‒ ⑂ Give(エ ⧕, Actor recipient)
        → Reach(recipient.み)
        ∧ While(Offer(⧕, recipient))?[ ⦿["Idle"] ]
        ∧ Present(⧕, recipient);

    ‒ ⑂ Grab(エ ⧕)
        → (Has(⧕) ∨ Reach(⧕))
        ∧ ⦿["Grab"] % After(0.5f)?[ Hold(⧕).now ];

    ‒ ⑂ Ingest(エ ⧕)
        → Hold(⧕, allowNull: ✓, hand: "L")
        ∧ ⦿["Eat"] % After(1.2f) ? [Destroy(⧕).now];

    ‒ ⑂ Idle → ⦿["Idle"];

    ‒ ⑂ LookAt(エ ⧕, ㄹ rotationAnim = "Walk", ㄹ idleAnim = "Idle")
        → Face(⧕, rotationAnim) ∧ ⦿[idleAnim];

    ‒ ⑂ Push(エ ⧕)
        → ❰Reach(⧕) ∧ PushingSetup()❱
        ∧ ⦿["Push"] ∧ PushingTeardown();

    ‒ ⑂ Strike(エ ⧕) → Reach(⧕) ∧ ⦿["Strike"];

    ‒ ⑂ Take()
        → (other ≠ ∅) ∧ Face(other.み) ∧ ⦿["Take"]
                      % After(0.5f)?[ Hold(gift).now ];

    ‒ ⑂ Tell(エ ⧕, ㄹ msg)
        → Reach(⧕) ∧ ⧼SpeechBox⧽.SetText(msg) ∧ ⦿["Tell"];

    ‒ ⑂ Throw(エ ⧕, シ dir)
        → ❰Hold(⧕)❱
        ∧ Face(dir) ∧ ⦿["Throw"] + After(0.5f)? [ Impel(⧕, dir) ];

    ‒ ⑂ Reach(エ ⧕, ㅅ dist = 1f)
        → Face(⧕) ∧ Playing("Walk", み.MoveTowards(⧕, dist, speed));

    // ==============================================================

    ‒ ㅇ IsLookingAt(Actor ⧕) → み.Look(⧕.み) < 5f;

    ‒ ㅇ Has(エ ⧕) → み.Has(⧕);

    // ==============================================================

    ▷ Hold(エ ⧕, ㅇ allowNull = ✗, ㄹ hand = "R")
        → Hold(⧕, hand ☰ "R" ? rightHold : leftHold, allowNull);

    ▷ Hold(エ ⧕, エ hold, ㅇ allowNull){
        ⤴ (hold ☰ ∅)
            (╯°□°)╯ ⌢ Ex("'hold' is null");
        ⤴ (⧕ ☰ ∅) ⮐ allowNull ? @void()
                                 : (╯°□°)╯ ⌢ Ex("that is null");
        ⧕.gameObject.SetActive(✓);
        ⤴ (⧕.parent ☰ hold) ⌽
        ∙ body = ⧕.⧼Rigidbody⧽;
        ⤴ (body) body.isKinematic = ✓;
        ⧕.SetParent(hold);
        ⧕.𝚙 = Palm(hold) + シ.⫫ * ⧕.Radius();
        ⌽
    }

    ▷ Impel(エ ⧕, シ dir, ㅅ force = 10f){
        ⧕.SetParent(∅);
        ∙ body = ⧕.⧼Rigidbody⧽;
        body.isKinematic = ✗;
        body.AddForce(dir¹ * 𝐹, ForceMode.Impulse);
        ⌽
    }

    ⑂ Offer(エ ⧕, Actor recipient)
        → Do(recipient.other = ⦿).now
        ∧ Do(recipient.gift  = ⧕).now
        ∧ +(⑂)recipient.IsLookingAt(⦿);

    ⑂ Present(エ ⧕, Actor recipient)
        → (recipient.Has(⧕) ∨ Hold(⧕).now) ∧ ⦿["Give"];

    ▷ PushingSetup(){
        UseRootMotion(✓);
        ∀ (エ x ∈ pushingBones){
            ∙ c = x.《SphereCollider》; c.radius = 0.05f;
            ∙ b = x.《Rigidbody》; b.isKinematic = ✓;
        } ⌽
    }

    ▷ PushingTeardown(){
        UseRootMotion(✗);
        ∀ (エ x ∈ pushingBones){
            Destroy(x.⧼SphereCollider⧽);
            Destroy(x.⧼Rigidbody⧽);
        } ⌽
    }

    ▷ UseRootMotion(ㅇ flag)
        → Do( ⧼Animator⧽.applyRootMotion = flag );

    // --------------------------------------------------------------

    メ Palm(エ hold){
        メ sum = メ.zero; ᆞ count = 1;
        ∀ (エ x ∈ hold){ sum += x.𝚙/2; count++; }
        sum /= count;
        ⮐ sum;
    }

}}
