âŠ Ex = System.Exception;
âŠ T = UnityEngine.Transform; âŠ UnityEngine;
âŠ Active.Core; âŠÌ¥ Active.Core.status; âŠ Active.Util;

âŠ“ Activ.Kabuki{
â€’ â—‹ Actor : Activ.Kabuki.XTask{

    â€’ ã…… speed = 1, rotationSpeed = 180;
    â€’ ã‚¨ leftHold, rightHold; // for holding an object in hand
    â€’ ã‚¨[] pushingBones;      // contact points for pushing
    â€’ Actor other;           // for give/take interaction
    â€’ ã‚¨ gift;
    â€’ Locomotion loco = âˆ…;

    // --------------------------------------------------------------

    â€’ â‘‚ â¦¿[ã„¹ gesture, ã‚¨ â§•] â†’ Face(â§•) âˆ§ â¦¿[gesture];

    â€’ â‘‚ â¦¿[ã„¹ anim] â†’ animDriver.Exists(anim)
        ? Play(anim)Ê¾
        : Wait(1f) % Play("Idle")Ê¾ % speechBox.SetText(anim);

    â€’ â‘‚ Face(ã‚¨ â§•, ã„¹ anim = "Walk")
        â†’ Playing(anim, ã¿.RotateTowards(â§•, rotationSpeed));

    â€’ â‘‚ Face(ãƒ¡ pos, ã„¹ anim = "Walk")
        â†’ Playing(anim, ã¿.RotateTowards(pos, rotationSpeed));

    â€’ â‘‚ Give(ã‚¨ â§•, Actor recipient)
        â†’ Reach(recipient.ã¿)
        âˆ§ While(Offer(â§•, recipient))?[ â¦¿["Idle"] ]
        âˆ§ Present(â§•, recipient);

    â€’ â‘‚ Grab(ã‚¨ â§•)
        â†’ (Has(â§•) âˆ¨ Reach(â§•)) âˆ§ â¦¿["Grab"] % After(0.5f)?[ Hold(â§•) ];

    â€’ â‘‚ Ingest(ã‚¨ â§•)
        â†’ Hold(â§•, allowNull: âœ“, hand: "L")
        & â¦¿["Eat"] % ( Wait(1.2f) âˆ§ Destroy(â§•) );

    â€’ â‘‚ Idle â†’ â¦¿["Idle"];

    â€’ â¨´ LookAt(ã‚¨ â§•, ã„¹ rotationAnim = "Walk", ã„¹ idleAnim = "Idle"){
        âˆ™ s = Face(â§•, rotationAnim) âˆ§ â¦¿[idleAnim];
        â˜¡Ì±Ê¿
    }

    â€’ â‘‚ Push(ã‚¨ â§•)
        â†’ â°Reach(â§•) âˆ§ PushingSetup() â±
        âˆ§ â¦¿["Push"] âˆ§ PushingTeardown() ;

    â€’ â‘‚ Reach(ã‚¨ â§•, ã…… dist = 1f)
        â†’ Face(â§•) âˆ§ Playing("Walk", ã¿.MoveTowards(â§•, dist, speed));

    â€’ status Reach(ã‚·? â§•) â†’ with(â§•)[
        !â§•.HasValue ? â—‡ :
        â°Face(â§•á–¾)â± âˆ§ Playing("Walk", loco?.MoveTo(ã¿, â§•á–¾, ğ‡)
                                      ?? ã¿.MoveTo(â§•á–¾, ğ‡))];

    // TODO: flakiness in "Reach" requires the Once node here.
    // if the memory node is removed the strike action will sometimes
    // stop half-way and repeat. Solution may be fix the "Reach"
    // action.
    â€’ â‘‚ Strike(ã‚¨ â§•) â†’ â°Reach(â§•)â± âˆ§ â¦¿["Strike"];

    â€’ â‘‚ Take()
        â†’ (other â‰  âˆ…) âˆ§ Face(other.ã¿) âˆ§ â¦¿["Take"]
                      % After(0.5f)?[ Hold(gift) ];

    â€’ â‘‚ Tell(ã‚¨ â§•, ã„¹ msg)
        â†’ â°Reach(â§•)â± âˆ§ speechBox.SetText(msg) âˆ§ â¦¿["Tell"];

    â€’ â‘‚ Throw(ã‚¨ â§•, ã‚· dir)
        â†’ â°Hold(â§•)â±
        âˆ§ Face(dir) âˆ§ â¦¿["Throw"] * After(0.5f)? [ Impel(â§•, dir) ];

    // ==============================================================

    â€’ ã…‡ IsLookingAt(Actor â§•) â†’ ã¿.Look(â§•.ã¿) < 5f;

    â€’ ã…‡ Has(ã‚¨ â§•) â†’ ã¿.Has(â§•);

    // ==============================================================

    â–· Hold(ã‚¨ â§•, ã…‡ allowNull = âœ—, ã„¹ hand = "R")
        â†’ Hold(â§•, hand â˜° "R" ? rightHold : leftHold, allowNull);

    â–· Hold(ã‚¨ â§•, ã‚¨ hold, ã…‡ allowNull){
        â¤´ (hold â˜° âˆ…)
            (â•¯Â°â–¡Â°)â•¯ âŒ¢ Ex("'hold' is null");
        â¤´ (â§• â˜° âˆ…) â® allowNull ? @void()
                                 : (â•¯Â°â–¡Â°)â•¯ âŒ¢ Ex("that is null");
        â§•.gameObject.SetActive(âœ“);
        â¤´ (â§•.parent â˜° hold) âŒ½
        âˆ™ body = â§•.â§¼Rigidbodyâ§½;
        â¤´ (body) body.isKinematic = âœ“;
        â§•.SetParent(hold);
        â§•.ğš™ = Palm(hold) + ã‚·.â«« * â§•.Radius();
        âŒ½
    }

    â–· Impel(ã‚¨ â§•, ã‚· dir, ã…… force = 10f){
        â§•.SetParent(âˆ…);
        âˆ™ body = â§•.â§¼Rigidbodyâ§½;
        body.isKinematic = âœ—;
        body.AddForce(dirÂ¹ * ğ¹, ForceMode.Impulse);
        âŒ½
    }

    â‘‚ Offer(ã‚¨ â§•, Actor recipient)
        â†’ Do(recipient.other = â¦¿)
        & Do(recipient.gift  = â§•)
        & +(â‘‚)recipient.IsLookingAt(â¦¿);

    â‘‚ Present(ã‚¨ â§•, Actor recipient)
        â†’ (recipient.Has(â§•) âˆ¨ Hold(â§•)) âˆ§ â¦¿["Give"];

    â–· PushingSetup(){
        UseRootMotion(âœ“);
        âˆ€ (ã‚¨ x âˆˆ pushingBones){
            âˆ™ c = x.ã€ŠSphereColliderã€‹; c.radius = 0.05f;
            âˆ™ b = x.ã€ŠRigidbodyã€‹; b.isKinematic = âœ“;
        } âŒ½
    }

    â–· PushingTeardown(){
        UseRootMotion(âœ—);
        âˆ€ (ã‚¨ x âˆˆ pushingBones){
            Destroy(x.â§¼SphereColliderâ§½);
            Destroy(x.â§¼Rigidbodyâ§½);
        } âŒ½
    }

    â–· UseRootMotion(ã…‡ flag) â†’ Do( â§¼Animatorâ§½.applyRootMotion = flag );

    // --------------------------------------------------------------

    ãƒ¡ Palm(ã‚¨ hold){
        ãƒ¡ sum = ãƒ¡.zero; á† count = 1;
        âˆ€ (ã‚¨ x âˆˆ hold){ sum += x.ğš™/2; count++; }
        sum /= count;
        â® sum;
    }

    SpeechBox speechBox â†’ â§¼SpeechBoxâ§½ ?? ã€ŠSpeechBoxã€‹;

}}
